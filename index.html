<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SolarPulse Pro | ERC Dharan</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --bg-main: #0b0f1a;
            --sidebar-bg: #111827;
            --card-bg: rgba(30, 41, 59, 0.5);
            --accent: #3b82f6;
            --text-main: #ffffff;
            --text-dim: #94a3b8;
            --glass-border: rgba(255, 255, 255, 0.08);
            --success: #10b981;
        }

        .light-mode {
            --bg-main: #f8fafc;
            --sidebar-bg: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.8);
            --text-main: #1e293b;
            --text-dim: #64748b;
            --glass-border: rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg-main); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; transition: 0.3s; }

        /* Sidebar Styling */
        aside { width: 300px; background: var(--sidebar-bg); border-right: 1px solid var(--glass-border); padding: 30px 24px; display: flex; flex-direction: column; z-index: 10; }
        .sidebar-header { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; }
        .logo-box { background: var(--accent); color: white; width: 42px; height: 42px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.4rem; }
        .main-title { font-weight: 700; font-size: 1.1rem; display: block; }
        .sub-title { font-size: 0.75rem; color: var(--text-dim); }

        .project-details-box { background: rgba(255,255,255,0.03); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border); margin-top: auto; }
        .project-details-box h3 { font-size: 0.75rem; color: var(--accent); text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px; }
        .project-details-box p { font-size: 0.8rem; color: var(--text-dim); line-height: 1.5; margin-bottom: 5px; }
        .badge { background: rgba(16, 185, 129, 0.15); color: var(--success); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; }

        /* Main Area */
        main { flex: 1; padding: 30px 40px; overflow-y: auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 35px; }
        .header-right { display: flex; gap: 15px; align-items: center; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .glass-card { background: var(--card-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 24px; padding: 24px; transition: 0.3s; }
        .glass-card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .card-icon { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; margin-bottom: 15px; background: rgba(59, 130, 246, 0.1); color: var(--accent); }
        .label { font-size: 0.85rem; color: var(--text-dim); }
        .stat-card h2 { margin-top: 5px; font-size: 1.7rem; font-weight: 700; }

        /* Charts Section */
        .visual-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; min-height: 400px; }
        .chart-container { height: 300px; width: 100%; margin-top: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        
        .btn-export { background: var(--accent); color: white; border: none; padding: 10px 18px; border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .theme-toggle { background: var(--card-bg); border: 1px solid var(--glass-border); color: var(--text-main); width: 42px; height: 42px; border-radius: 10px; cursor: pointer; }

        /* Status Indicator */
        .connection-status { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: var(--text-dim); }
        .pulse-icon { width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 0 rgba(16, 185, 129, 0.4); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
    </style>
</head>
<body>

    <aside>
        <div class="sidebar-header">
            <div class="logo-box"><i class="ph-fill ph-sun"></i></div>
            <div><span class="main-title">SolarPulse</span><span class="sub-title">ERC Monitoring</span></div>
        </div>

        <nav style="margin-top: 20px;">
            <div style="padding: 12px; background: var(--accent); border-radius: 12px; display: flex; align-items: center; gap: 10px; color: white; cursor: pointer;">
                <i class="ph ph-squares-four"></i> Overview
            </div>
            <div onclick="window.location.href='php/export.php'" style="padding: 12px; margin-top: 10px; border-radius: 12px; display: flex; align-items: center; gap: 10px; color: var(--text-dim); cursor: pointer;">
                <i class="ph ph-file-csv"></i> Download CSV
            </div>
        </nav>

        <div class="project-details-box">
            <h3>Project Info</h3>
            <p><strong>System:</strong> <span class="badge">Live IoT Node</span></p>
            <p><strong>Hardware:</strong> ESP32 + ACS712</p>
            <p><strong>Campus:</strong> ERC, Dharan</p>
            <p style="margin-top: 10px; font-size: 0.75rem; border-top: 1px solid var(--glass-border); pt: 10px;">Monitoring the efficiency of 200W solar arrays in real-time.</p>
        </div>
    </aside>

    <main>
        <header>
            <div>
                <h1 style="font-size: 1.5rem;">Energy Dashboard</h1>
                <p id="full-date" style="color: var(--text-dim); font-size: 0.85rem;"></p>
            </div>
            <div class="header-right">
                <div class="connection-status">
                    <div class="pulse-icon" id="status-dot"></div>
                    <span id="status-text">Server Online</span>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()"><i class="ph ph-moon" id="t-icon"></i></button>
                <button class="btn-export" onclick="window.location.href='php/export.php'"><i class="ph ph-download-simple"></i> Export</button>
            </div>
        </header>

        <div class="stats-grid">
            <div class="glass-card stat-card">
                <div class="card-icon"><i class="ph ph-lightning"></i></div>
                <span class="label">Power Output</span>
                <h2 id="val-power">0.00 W</h2>
            </div>
            <div class="glass-card stat-card">
                <div class="card-icon" style="color:#10b981; background:rgba(16,185,129,0.1)"><i class="ph ph-plug"></i></div>
                <span class="label">Bus Voltage</span>
                <h2 id="val-volt">0.0 V</h2>
            </div>
            <div class="glass-card stat-card">
                <div class="card-icon" style="color:#f59e0b; background:rgba(245,158,11,0.1)"><i class="ph ph-wave-sine"></i></div>
                <span class="label">Panel Current</span>
                <h2 id="val-curr">0.00 A</h2>
            </div>
            <div class="glass-card stat-card">
                <div class="card-icon" style="color:#8b5cf6; background:rgba(139,92,246,0.1)"><i class="ph ph-thermometer"></i></div>
                <span class="label">Temperature</span>
                <h2 id="val-temp">0°C</h2>
            </div>
        </div>

        <div class="visual-grid">
            <div class="glass-card">
                <div class="card-header"><h3>Generation Trend (W)</h3></div>
                <div class="chart-container"><canvas id="mainChart"></canvas></div>
            </div>
            <div class="glass-card">
                <div class="card-header"><h3>Peak Efficiency</h3></div>
                <div class="chart-container"><canvas id="distChart"></canvas></div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'php/getdata.php';
        let mainChart, distChart;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('full-date').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            initCharts();
            fetchData();
            setInterval(fetchData, 3000); 
        });

        // --- Charts Setup ---
        function initCharts() {
            const ctx1 = document.getElementById('mainChart').getContext('2d');
            mainChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Watts',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
            });

            const ctx2 = document.getElementById('distChart').getContext('2d');
            distChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Current', 'Gap'],
                    datasets: [{ data: [0, 100], backgroundColor: ['#3b82f6', 'rgba(255,255,255,0.05)'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '80%' }
            });
        }

        // --- Data Handling ---
        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                if (data.length > 0) {
                    const latest = data[data.length - 1];
                    updateUI(latest);
                    updateCharts(data);
                    setStatus(true);
                }
            } catch (e) { setStatus(false); }
        }

        function updateUI(d) {
            document.getElementById('val-power').innerText = `${parseFloat(d.power).toFixed(2)} W`;
            document.getElementById('val-volt').innerText = `${parseFloat(d.voltage).toFixed(1)} V`;
            document.getElementById('val-curr').innerText = `${parseFloat(d.current).toFixed(2)} A`;
            document.getElementById('val-temp').innerText = `${parseFloat(d.temp).toFixed(1)}°C`;
        }

        function updateCharts(history) {
            mainChart.data.labels = history.map(row => row.timestamp.split(' ')[1]);
            mainChart.data.datasets[0].data = history.map(row => row.power);
            mainChart.update('none');

            const p = parseFloat(history[history.length - 1].power);
            distChart.data.datasets[0].data = [p, 200 - p];
            distChart.update();
        }

        function setStatus(online) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            dot.style.background = online ? '#10b981' : '#ef4444';
            text.innerText = online ? "Server Online" : "Connection Lost";
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            const icon = document.getElementById('t-icon');
            icon.className = document.body.classList.contains('light-mode') ? 'ph ph-sun' : 'ph ph-moon';
        }
    </script>
</body>
</html>